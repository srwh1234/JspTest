<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Document</title>

    <!-- 套件 -->
    <!-- boostrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />

    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.3.0/mdb.min.css" rel="stylesheet" />

    <!-- itinerary.css -->
    <link rel="stylesheet" type="text/css" href="css/itinerary.css">

    <!-- soft table -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css" />

    <!-- slick -->
    <link rel="stylesheet" type="text/css" href="slick/slick.css" />
    <link rel="stylesheet" type="text/css" href="slick/slick-theme.css" />

    <!-- jay's -->
    <!-- css files -->
    <link href="css/bootstrap.css" rel="stylesheet" type="text/css" />
    <!-- bootstrap css -->
    <link href="css/style.css" rel="stylesheet" type="text/css" />
    <!-- custom css -->
    <link href="css/fontawesome-all.css" rel="stylesheet" />
    <!-- fontawesome css -->
    <!-- //css files -->

    <!-- google fonts -->
    <!-- 載入字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC&display=swap" rel="stylesheet" />
    <!-- //google fonts -->

    <!-- 載入icon -->
    <link rel="shortcut icon" href="./images/icon.png" />
    <link rel="bookmark" href="./images/icon.png" />

    <!-- yen -->
    <!--jQuery-->
    <!-- <link href="https://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="https://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script> -->
    <!--會員登入-->
    <link href="css/login.css" rel="stylesheet" />

    <style>
        .star {
            color: grey;
        }

        .star:hover,
        .star.active {
            color: yellow;
        }

        .btnCustom {
            background-color: #38d8fc;
            border: none;
        }

        .btnCustom:hover {
            background-color: #00bdff;
            border: none;
        }
    </style>

</head>

<body>
    <!-- ===== 導覽列 ===== -->
    <!-- header -->
    <header>
        <div class="container" style="padding-right: 0px">
            <!-- nav -->
            <nav class="py-md-4 py-3">
                <div id="logo">
                    <h1 class="mt-md-0 mt-2">
                        <a href="index.html"><img src="./images/icon.png" class="icon_triplight" />
                            TripLight
                        </a>
                    </h1>
                </div>
                <label for="drop" class="toggle"><span class="fa fa-bars"></span></label>
                <input type="checkbox" id="drop" />
                <ul class="menu ml-auto mt-1">
                    <li class=""><a href="index.html">首頁</a></li>
                    <li class=""><a href="booking.html">AI行程規劃</a></li>
                    <li class="active"><a href="tickets.html">票券</a></li>
                    <li class=""><a href="itinerary_search.html?index=1">套裝行程</a></li>
                    <li class=""><a href="articles.html">旅遊文章</a></li>
                    <li class="booking"><a href="" id="login">登入/註冊</a></li>
                    <li class="">
                        <a href="shopping_car.html"><img src="./images/shoppingCar.svg" alt="" style="width: 2em" /></a>
                    </li>
                </ul>
            </nav>
            <!-- //nav -->

            <div class="member">
                <ul class="member_list">
                    <li class="member_li"><a href="login.html"><i class="fa-regular fa-user"></i>管理帳戶</a>
                    </li>
                    <li class="member_li" id="order_li"><a href=""><i class="fa-solid fa-plane"></i>訂單管理</a>
                        <ul class="order_list">
                            <li class="order_content"><a href="tickets_order.html"><i
                                        class="fa-solid fa-ticket"></i>票券訂單</a></li>
                            <li class="order_content"><a href="group_order.html"><i
                                        class="fa-solid fa-suitcase"></i>旅遊團訂單</a>
                            </li>
                        </ul>
                    </li>
                    <li class="member_li"><a href="my_favorite.html"><i class="fa-regular fa-heart"></i>我的收藏</a></li>
                    <li class="member_li"><a href="article_mylist.html"><i class="fa-solid fa-copy"></i>我的文章</a>
                    </li>
                    <li class="member_li"><a href="membership_rating.html"><i class="fa-regular fa-gem"></i>會員分級</a>
                    </li>
                    <li class="member_li"><a href="question_form.html"><i class="fa-regular fa-comment"></i>提出問題</a>
                    </li>
                    <li class="member_li"><a href="read_question_list.html"><i
                                class="fa-regular fa-comment"></i>查看問題</a>
                    </li>
                    <li class="member_li" id="logout_li"><a href="index.html"><i
                                class="fa-solid fa-right-from-bracket"></i>登出</a></li>
                </ul>
            </div>
        </div>
    </header>
    <!-- //header -->
    <!-- 登入 -->
    <div id="login-container">
        <!---container--->

        <div class="main-box login">
            <h3>登入</h3>
            <form action="">
                <div class="input-box">
                    <i class="fas fa-envelope icon2"></i> <input type="email" name="email" id="email" required /> <label
                        for="">信箱</label>
                </div>
                <div class="input-box">
                    <i class="fas fa-lock icon2"></i> <input type="password" name="password" id="password" required />
                    <label for="">密碼</label>
                </div>
                <div class="check">
                    <label><input type="checkbox" />記住我</label> <a href="#" id="forgetPwd">忘記密碼</a>
                </div>
                <button type="submit" class="main-btn">Login</button>
                <div class="register">
                    <p>
                        如果沒有帳號?<a href="#" class="register-link">點擊註冊</a>
                    </p>
                </div>
            </form>
        </div>

        <div class="main-box register">
            <h3>註冊</h3>
            <form action="">
                <div class="input-box">
                    <i class="fas fa-user icon2"></i> <input type="email" name="account" id="register_account"
                        required /> <label for="">使用者名稱</label>
                </div>
                <div class="input-box">
                    <i class="fas fa-envelope icon2"></i> <input type="email" name="email" id="register_email"
                        required /> <label for="">信箱</label>
                </div>
                <div class="input-box">
                    <i class="fas fa-lock icon2"></i> <input type="password" name="password" id="register_password"
                        required />
                    <label for="">密碼</label>
                    <h6 id="pwdHint">密碼設定請超過八碼</h6>
                </div>
                <div class="check">
                    <label><input type="checkbox" />我同意所有條款</label>
                </div>
                <button type="submit" class="main-btn">註冊</button>
                <div class="register">
                    <p>
                        已經有帳號?<a href="#" class="login-link">點擊登入</a>
                    </p>
                </div>
            </form>
        </div>

        <span class="close-icon">
            <div class="fas fa-times"></div>
        </span>
    </div>
    <!-- 登入  -->

    <!-- banner -->
    <section class="banner_inner" id="home">
        <div class="banner_inner_overlay"></div>
    </section>
    <!-- //banner -->


    <!-- ===== 導覽列 ===== -->

    <!-- ===== 開始 ===== -->

    <div class="container mt-5 shadow-none p-3 mb-5 bg-light rounded">

        <div class="row">
            <!-- 麵包屑 -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="http://localhost:8080/front-end/group_order.html">訂單</a></li>
                    <li class="breadcrumb-item active" aria-current="page">訂單詳情</li>
                </ol>
            </nav>
            <!-- 麵包屑 -->
            <div class="row shadow-lg p-3 mb-5 bg-body rounded">
                <div class="row">
                    <div class="col-3 ml-5">
                        <!--                        <button type="button" class="btn btn-info">已出發</button>-->
                    </div>
                </div>
                <!--     第一列-->
                <div class="col-8">
                    <ul class="list-group list-group-flush p-3">
                        <li class="list-group-item" id="tripOrderId">訂單編號: </li>
                        <li class="list-group-item" id="memberName">會員姓名: </li>
                        <li class="list-group-item" id="memberPhone">會員電話: </li>
                        <li class="list-group-item" id="payDate"> 訂購日期: </li>
                        <li class="list-group-item" id="orderStatus"> 訂單狀態: </li>

                    </ul>

                </div>
                <div class="col-4" id="btn_parent">
                    <button type="button" id="tripPage"
                        class="btn btnCustom btnCustom:hover btn-secondary btn-rounded btn-lg mt-3">行程詳情</button>
                    <br>
                    <button type="button" class="btn btnCustom btnCustom:hover btn-secondary btn-rounded btn-lg mt-3"
                        data-bs-toggle="modal" data-bs-target="#exampleModal" data-mdb-ripple-color="white"
                        id="btn_modal">我要評論</button>
                    <br>
                    <button type="button" class="btn btnCustom btnCustom:hover btn-secondary btn-rounded btn-lg mt-3"
                            data-bs-toggle="modal" data-bs-target="#exampleModal" data-mdb-ripple-color="white"
                            id="payment_btn">我要付款</button>
                    <br>


                </div>
            </div>

            <!-- 我要評論 燈箱區 -->
            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">評論內容</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="mb-5">
                                    <i class="fa-solid fa-star fa-xl star" value="1"></i>
                                    <i class="fa-solid fa-star fa-xl star" value="2"></i>
                                    <i class="fa-solid fa-star fa-xl star" value="3"></i>
                                    <i class="fa-solid fa-star fa-xl star" value="4"></i>
                                    <i class="fa-solid fa-star fa-xl star" value="5"></i>

                                </div>
                                <div class="mb-5">
                                    <label for="modal-text" class="col-form-label">請留下您的寶貴意見:</label>
                                    <textarea class="form-control" id="modal-text"></textarea>
                                </div>
                            </form>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" id="btn_con" class="btn btn-primary"
                                data-bs-dismiss="modal">確認評論</button>
                        </div>

                    </div>
                </div>
            </div>


            <!--  第二列  -->
            <div class="row shadow-lg p-3 mb-5 bg-body rounded">
                <h3 class="pt-2"> 訂購資訊 </h3>
                <hr>
                <div class="col-10">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item" id="tourGroupDate"> 旅遊團日期: </li>
                        <li class="list-group-item" id="tripName"> 方案: </li>
                        <li class="list-group-item" id="travelerNo">旅客人數: </li>
                        <li class="list-group-item" id="remarks">特殊需求: </li>
                    </ul>
                </div>

            </div>

            <!--  第三列  -->
            <div class="shadow-lg p-3 mb-5 bg-body rounded">

                <h3 class="pt-2"> 旅客名單 </h3>
                <hr>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col"></th>
                            <th scope="col">姓名</th>
                            <th scope="col">年齡</th>
                            <th scope="col">性別</th>
                            <th scope="col">電話</th>
                            <th scope="col">郵件</th>
                        </tr>
                    </thead>
                    <tbody id="travelerList">

                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- ===== 結束 ===== -->
    <!--footer -->
    <footer>
        <section class="footer footer_w3layouts_section_1its py-5">
            <div class="container py-lg-4 py-3">
                <div class="row footer-top">
                    <div class="col-lg-3 col-sm-6 footer-grid_section_1">
                        <div class="footer-title">
                            <h3>地點資訊</h3>
                        </div>
                        <div class="row">
                            <ul class="col-12 links">
                                <li>
                                    <a href="https://www.google.com/maps?q=桃園市中壢區復興路46號9樓"
                                        target="_blank">地址：桃園市中壢區復興路46號9樓</a>
                                </li>
                                <li><a href="tel:02-1234-5678">電話：02-1234-5678</a></li>
                                <li>
                                    <a href="mailto:triplight0411@gmail.com">信箱：triplight0411@gmail.com</a>
                                </li>
                                <li><a href="tel:02-1234-5678">傳真：02-1234-5678</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 footer-grid_section mt-sm-0 mt-4">
                        <div class="footer-title">
                            <h3>認識TripLight</h3>
                        </div>
                        <div class="row">
                            <ul class="col-10 links">
                                <li><a href="about.html" class="scroll">關於我們</a></li>
                                <li>
                                    <a href="user_terms.html" class="scroll">使用者條款 </a>
                                </li>
                                <li>
                                    <a href="privacy_policy.html" class="scroll">隱私權保護政策</a>
                                </li>
                                <li><a href="faq.html" class="scroll"> 常見問題與幫助</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 mt-lg-0 mt-4 footer-grid_section_1">
                        <div class="footer-title">
                            <h3>成為合作夥伴</h3>
                        </div>
                        <div class="row">
                            <ul class="col-10 links">
                                <li>
                                    <a href="supplier_form.html" class="scroll">成為供應商</a>
                                </li>
                                <li>
                                    <a href="blogger_photographer.html" class="scroll">部落客/攝影師合作計畫</a>
                                </li>
                                <li>
                                    <a href="group_form.html" class="scroll">團體客製規劃</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-sm-6 mt-lg-0 mt-4 footer-grid_section_1">
                        <div class="footer-title">
                            <h3>聯絡我們</h3>
                        </div>
                        <ul class="social_section_1info">
                            <li>
                                <a href="https://www.facebook.com/TibaMe"><img src="./images/facebook.svg"
                                        alt="facebook" /></a>
                            </li>
                            <li>
                                <a href="https://www.instagram.com/tibame_wiedu/"><img src="./images/instagram.svg"
                                        alt="instagram" /></a>
                            </li>
                            <li>
                                <a href="https://twitter.com/"><img src="./images/twitter.svg" alt="twitter" /></a>
                            </li>
                            <li class="youtube">
                                <a href="https://www.youtube.com/channel/UClhecf7eOGHwbKW5e7l_pTA"><img
                                        src="./images/youtube.svg" alt="youtube" /></a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </footer>
    <!-- //footer -->
    <!-- copyright -->
    <div class="copyright py-3 text-center">
        <p>COPYRIGHT © 2023 TripLight All rights reserved.</p>
    </div>
    <!-- //copyright -->



    <!-- ======================== Lib ============================================-->

    <!-- boostrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>

    <!-- 載入jQuery -->
    <script src="./js/bootstrap.bundle.min.js"></script>
    <script src="./js/jquery-3.6.4.min.js"></script>

    <!-- 載入 Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"></script>

    <!-- MDB -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.3.1/mdb.min.js"></script>
    <!-- 載入 slick -->
    <script type="text/javascript" src="slick/slick.min.js"></script>

    <!-- 載入 Full Calendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.7/index.global.min.js"></script>


    <!-- 載入 sweetalert -->
    <script src="./js/sweetalert.js"></script>

    <!-- ======================== Java Script ============================================-->

    <script>

        $(document).ready(function () {

            // ====== 函式 ======
            function getMemberId() {

                const testLogIn = JSON.parse(sessionStorage.getItem('test-login'));
                if (!testLogIn || !testLogIn.memberId) {
                    return 0;
                }
                return testLogIn.memberId;
            }

            // ====== 取得session 資訊 ======
            const memberId = getMemberId();
            const tripOrderId = sessionStorage.getItem('tripOrderId');
            const tripId = sessionStorage.getItem('tripId');
            const tourGroupId = sessionStorage.getItem('tourGroupId');

            $('#tripPage').on('click', function (){
                window.location.href = `/front-end/itinerary_page.html?tripId=${tripId}`;
            });

            $('#payment_btn').on('click', function (){
                window.location.href = `/front-end/group_orderpayment.html?memberId=${memberId}&tripOrderId=${tripOrderId}`;
            });

            // $('#tripPage').on('click', function () {
            //     sessionStorage.setItem('tripId', tripId);
            //     window.location.href = `/front-end/itinerary_page.html`;
            // });

            let paymentStatus;
            // ====== 取得旅遊團人員資訊 ======
            $.getJSON(`/groupOrderDetail/getTravelerList?memberId=${memberId}&tourGroupId=${tourGroupId}&`, function (response) {

                let parentEl = $('#travelerList');

                for (let i = 0; i < response.length; i++) {

                    if (response[i].travelerGender === 1) {
                        let childEl = `
                            <tr>
                                    <th scope="row">${i + 1}</th>
                                    <td>${response[i].travelerName}</td>
                                    <td>${response[i].travelerAge}</td>
                                    <td>男</td>
                                    <td>${response[i].travelerPhone}</td>
                                    <td>${response[i].travelerEmail}</td>
                            </tr>`;
                        parentEl.append(childEl);
                    } else {

                        let childEl = `
                            <tr>
                                    <th scope="row">${i + 1}</th>
                                    <td>${response[i].travelerName}</td>
                                    <td>${response[i].travelerAge}</td>
                                    <td>女</td>
                                    <td>${response[i].travelerPhone}</td>
                                    <td>${response[i].travelerEmail}</td>
                            </tr>
                                 `;
                        parentEl.append(childEl);
                    }
                }
            });


            // ====== 取得會員資訊 ======
            $.getJSON(`/groupOrderDetail/getMemberInfor?memberId=${memberId}`, function (response) {
                $('#memberName').html(`會員姓名: ${response.memberNameLast + response.memberNameFirst}`);
                $('#memberPhone').html(`連絡電話: ${response.memberPhone}`);

            });

            // ====== 取得旅遊團日期 與 名稱 ======
            $.getJSON(`/groupOrderDetail/getTourGroupDate?tripId=${tripId}&tourGroupId=${tourGroupId}`, function (response) {
                $('#tourGroupDate').html(`旅遊團日期: ${response.formattedStartDate} 至 ${response.formattedEndDate}`);
                $('#tripName').html(`方案: ${response.tripName}`);


            });



            // ====== 取得訂單資訊 ======
            $('#tripOrderId').text(`訂單編號: ${tripOrderId}`);
            $.getJSON(`/groupOrderDetail/getTripInfor?tripOrderId=${tripOrderId}`, function (response) {
                paymentStatus = response[0].paymentStatus;

                // paymentStatus 為0 則未付款並且付款日期內不會有資料
                if (response[0].paymentStatus === 0) {
                    $('#payDate').text(`付款日期 : 尚未付款`);

                } else {
                    $('#payDate').text(`付款日期 : ${response[0].formattedPayDate}`);
                }

                if (response[0].orderStatus == 0 && response[0].paymentStatus == 0) {

                    let childBtn = `
                    <button onclick="location.href='/front-end/group_orderpayment.html?memberId=${memberId}&tripOrderId=${tripOrderId}'">
                     type="button" class="btn btn-secondary btn-rounded btn-lg mt-3">我要付款</button>
                    `;

                    $('#btn_parent').append()


                }

                // 判斷是否成團
                if (response[0].orderStatus == 0) {
                    $('#orderStatus').text('訂單狀態 : 成團');


                } else if (response[0].orderStatus == 1) {
                    $('#orderStatus').text('訂單狀態 : 未成團');

                }

                // 人數
                $('#travelerNo').html(`人數: ${response[0].travelersAdult + response[0].travelersAdult} 人`);

                // 特殊需求
                if (response[0].remarks === undefined) {
                    $('#remarks').text('特殊需求: 無');
                } else {
                    $('#remarks').html(`特殊需求: ${response[0].remarks}`);
                }

            });

            // ====== 評論功能 ======

            // ====== 取得評論次數，若已經評論過，則disable 評論按鈕 ======
            let editCount;

            $.getJSON(`/groupOrderDetail/getEditCount?tripOrderId=${tripOrderId}`, function (response) {
                editCount = response;

                if (editCount === 1) {
                    $('#btn_modal').text('評論完成');
                    $('#btn_modal').attr('data-bs-target', '#');
                    $('#btn_modal').on('click', function () {
                        Swal.fire('您已經評論過了唷');
                    });
                } else if (editCount === 0 && paymentStatus === 0) {
                    // 資料庫內無評論資料，並且paymentStatus === 1 顯示尚未付款，則評論的功能也無法使用
                    $('#btn_modal').text('我要評論');
                    $('#btn_modal').attr('data-bs-target', '#');
                    $('#btn_modal').on('click', function () {
                        Swal.fire('尚未付款，還不能評論唷');
                    });
                }
            });

            // 星星功能
            $('.star').click(function () {
                // 移除所有星星的 'active' 类
                $('.star').removeClass('active');

                // 将点击的星星和它之前的所有星星添加 'active' 类
                $(this).prevAll('.star').addBack().addClass('active');

            });


            // ====== 將評論送進資料庫，確認星星與評論是否為空值 ======
            $('#btn_con').on('click', function () {

                // 將選取的.star.active 選取的最後一個星星數值存入
                let rating = $('.star.active').last().attr('value');
                let comment = $('#modal-text').val();

                if (rating === undefined) {
                    Swal.fire('請選擇評分星星');

                } else if (comment === '') {
                    Swal.fire('請輸入評論喔');

                } else {

                    let data = {
                        'tripId': tripId,
                        'memberId': memberId,
                        'rating': rating,
                        'comment': comment,
                        'status': '1',
                        'edit_count': '1',
                        'tripOrderId': tripOrderId
                    }

                    let datajson = JSON.stringify(data);

                    // ====== 將評論內容送至資料庫後，disable 評論按鈕的功能 ======
                    $.post("/groupOrderDetail/addTripComments", datajson, function (response) {
                        $('#btn_modal').text('評論完成');
                        $('#btn_modal').attr('data-bs-target', '#');
                        $('#btn_modal').on('click', function () {
                            Swal.fire('您已經評論過了唷');
                        });

                    });

                    Swal.fire('謝謝您的評論唷');

                }


            })




            // ====== //評論功能 ======

        });


    </script>

    <!-- login顯示 -->
    <script src="js/Login.js"></script>
    <!-- login顯示 -->
</body>

</html>